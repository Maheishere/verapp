<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Responsible Prompting Toolkit v5</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 20px; background-color: #f9f9f9; }
        h1, h2, h3, h4 { margin-top: 0; }
        .container { display: flex; width: 100%; max-width: 1600px; margin: 0 auto; gap: 20px; }
        .col { width: 50%; display: flex; flex-direction: column; gap: 15px; }
        textarea, input[type="text"] { width: 98%; padding: 10px; font-family: monospace; font-size: 14px; border: 1px solid #ccc; border-radius: 5px; }
        textarea { height: 150px; }
        button { padding: 10px 15px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; background-color: #007bff; color: white; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button.success { background-color: #28a745; }
        button.warning { background-color: #ffc107; }
        button.info { background-color: #17a2b8; }
        .report-box { border: 1px solid #eee; padding: 15px; min-height: 100px; background-color: white; border-radius: 5px; }
        .experiment-box { border: 1px solid #ccc; padding: 15px; min-height: 200px; background-color: white; border-radius: 5px; }
        #status-display { font-weight: bold; color: #555; height: 20px; }
        .impact-1 { background-color: rgba(0, 128, 0, 0.15); padding: 3px 6px; border-radius: 4px; }
        .impact-2 { background-color: rgba(0, 128, 0, 0.3); padding: 3px 6px; border-radius: 4px; }
        .impact-3 { background-color: rgba(255, 165, 0, 0.5); padding: 3px 6px; border-radius: 4px; }
        .impact-4 { background-color: rgba(255, 0, 0, 0.6); padding: 3px 6px; border-radius: 4px; }
        .impact-5 { background-color: rgba(255, 0, 0, 0.8); color: white; padding: 3px 6px; border-radius: 4px; }
        .report-item { margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px dotted #ccc; line-height: 1.6; }
        .prompt-word-high { background-color: rgba(255, 0, 0, 0.6); color: white; padding: 3px 6px; border-radius: 4px; font-weight: bold; }
        .prompt-word-med { background-color: rgba(255, 165, 0, 0.5); padding: 3px 6px; border-radius: 4px; font-weight: bold; }
        .arrow { font-size: 1.5em; color: #555; margin: 0 10px; }
        .output-word { background-color: #f0f0f0; padding: 2px 5px; border-radius: 4px; font-family: monospace; }
        .change-report { border: 1px solid #ddd; border-radius: 5px; padding: 10px; margin-top: 15px; }
        .score-bar-container { background-color: #f0f0f0; border-radius: 5px; overflow: hidden; }
        .score-bar-fill { height: 25px; line-height: 25px; background-color: #888; color: white; padding: 0 10px; font-weight: bold; text-align: center; text-shadow: 1px 1px 1px #333; transition: width 0.5s ease-in-out; }
        .change-summary { margin-top: 8px; font-style: italic; }
        .compare-container { display: flex; width: 100%; }
        .compare-box { width: 50%; padding: 10px; }
        .compare-before { border-right: 1px solid #ccc; }
    </style>
</head>
<body>
    <h1>Responsible Prompting Toolkit v5</h1>
    <div id="status-display"></div>
    <div class="container">
        <div class="col">
            <h3>1. Generate and Analyze</h3>
            <textarea id="prompt-input">Write a short, formal, and polite email to my manager about a sick day.</textarea>
            <button id="b-generate">1. Generate Output</button>
            <textarea id="output-display" placeholder="Output will appear here..." readonly></textarea>
            <button id="b-analyze" class="success" disabled>2. Analyze Significance</button>
            <div id="analysis-report-display" class="report-box"></div>
        </div>
        <div class="col">
            <h3>2. Run Experiments</h3>
            <h4>Ablation Study (Remove Words)</h4>
            <input type="text" id="ablation-input" placeholder="e.g., formal, polite">
            <button id="b-ablate" class="warning">Run Ablation Study</button>
            <h4 style='margin-top: 20px;'>Counterfactual Study (Replace Words)</h4>
            <textarea id="counterfactual-input" style="height: 70px;" placeholder='e.g., {"formal": "informal", "sick": "personal"}'></textarea>
            <button id="b-counterfactual" class="info">Run Counterfactual Study</button>
            <div id="experiment-display" class="experiment-box"></div>
        </div>
    </div>

    <script>
        // --- 1. Get DOM Elements ---
        const status = document.getElementById('status-display');
        const promptInput = document.getElementById('prompt-input');
        const outputDisplay = document.getElementById('output-display');
        const ablationInput = document.getElementById('ablation-input');
        const counterfactualInput = document.getElementById('counterfactual-input');
        const bGenerate = document.getElementById('b-generate');
        const bAnalyze = document.getElementById('b-analyze');
        const bAblate = document.getElementById('b-ablate');
        const bCounterfactual = document.getElementById('b-counterfactual');
        const analysisDisplay = document.getElementById('analysis-report-display');
        const experimentDisplay = document.getElementById('experiment-display');

        // --- 2. App State ---
        const appState = {
            original_prompt: "",
            original_output: "",
            original_analysis: {}
        };

        // --- 3. UI Helper Functions (HTML Builders) ---
        function buildHeatmapHTML(heatmapData) {
            if (!heatmapData || heatmapData.length === 0) {
                return "<p><i>No heatmap data available.</i></p>";
            }
            let html = "<div style='line-height: 2.0;'>";
            heatmapData.forEach(item => {
                const word = item.word || '';
                const score = item.impact_score || 0;
                html += `<span class="impact-${score}">${word}</span> `;
            });
            html += "</div>";
            return html;
        }
        function buildReportHTML(connectionsData) {
            if (!connectionsData || connectionsData.length === 0) {
                return "<p><i>No key connections identified.</i></p>";
            }
            let html = "";
            connectionsData.forEach(item => {
                const promptWord = item.prompt_word || 'N/A';
                const score = item.impact_score || 0;
                const outputWords = item.influenced_output_words || [];
                const promptStyle = score >= 4 ? "prompt-word-high" : "prompt-word-med";
                html += `<div class="report-item"><span class="${promptStyle}">${promptWord}</span><span class="arrow">â†’</span>`;
                if (outputWords.length === 0) {
                    html += "<i>(No direct output words identified)</i>";
                } else {
                    html += outputWords.map(word => `<span class="output-word">${word}</span>`).join(' ');
                }
                html += '</div>';
            });
            return html;
        }
        function buildScoreHTML(scoreData) {
            const score = Math.max(1, Math.min(10, scoreData.semantic_change_score || 0));
            const summary = scoreData.change_summary || 'N/A';
            const red = Math.floor((score - 1) * (255 / 9));
            const green = 255 - red;
            const color = `rgb(${red}, ${green}, 0)`;
            return `
            <div class="change-report">
                <strong>Impact Score:</strong>
                <div class="score-bar-container">
                    <div class="score-bar-fill" style="width: ${score * 10}%; background-color: ${color};">${score} / 10</div>
                </div>
                <div class="change-summary"><strong>Summary:</strong> ${summary}</div>
            </div>`;
        }
        
        // --- 4. Main Event Handlers ---
        bGenerate.addEventListener('click', async () => {
            setLoadingState(true, 'Generating...');
            appState.original_prompt = promptInput.value;
            
            // --- ðŸ”´ CHANGED LINE ---
            const response = await fetch('/generate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ prompt: appState.original_prompt })
            });
            const data = await response.json();
            appState.original_output = data.output || data.error;
            outputDisplay.value = appState.original_output;
            appState.original_analysis = {};
            analysisDisplay.innerHTML = "";
            experimentDisplay.innerHTML = "";
            bAnalyze.disabled = false;
            setLoadingState(false);
        });
        
        bAnalyze.addEventListener('click', async () => {
            setLoadingState(true, 'Analyzing...');
            
            // --- ðŸ”´ CHANGED LINE ---
            const response = await fetch('/analyze', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ prompt: appState.original_prompt, output: appState.original_output })
            });
            const data = await response.json();
            appState.original_analysis = data;
            if (data.error) {
                analysisDisplay.innerHTML = `<p style="color: red; font-weight: bold;">
                    Analysis Failed:
                </p><p style="font-family: monospace; background-color: #fdd; padding: 10px;">${data.error}</p>`;
                setLoadingState(false);
                return;
            }
            const heatmapHTML = buildHeatmapHTML(data.heatmap_data);
            const reportHTML = buildReportHTML(data.connections);
            analysisDisplay.innerHTML = `
                <h4>Prompt Heatmap</h4>
                <details style="margin-bottom: 15px; font-size: 0.9em; color: #555;">
                    <summary style="cursor: pointer; font-weight: bold;">How is this heatmap computed?</summary>
                    <div style="padding: 10px; border: 1px solid #eee; border-radius: 5px; margin-top: 5px; background-color: #fafafa;">
                        <p style="margin-top: 0;">An AI model analyzes your prompt and its output, assigning an "impact score" (1-5) to every word.</p>
                        <b>Legend:</b>
                        <ul style="margin: 5px 0 0 20px; padding: 0; list-style-type: none;">
                            <li><span class="impact-5" style="padding:2px 4px; border-radius:3px; display: inline-block; width: 20px; text-align: center;">5</span> High Impact: Critical to the output.</li>
                            <li><span class="impact-3" style="padding:2px 4px; border-radius:3px; display: inline-block; width: 20px; text-align: center;">3</span> Medium Impact: Moderate influence.</li>
                            <li><span class="impact-1" style="padding:2px 4px; border-radius:3px; display: inline-block; width: 20px; text-align: center;">1</span> Low Impact: Minor word (e.g., 'a', 'the').</li>
                        </ul>
                    </div>
                </details>
                ${heatmapHTML}
                <h4 style='margin-top: 20px;'>Significance Report</h4>
                ${reportHTML}`;
            if (data.heatmap_data) {
                let highImpactWords = data.heatmap_data
                    .filter(item => (item.impact_score || 0) >= 4 && item.word && /^[a-zA-Z0-9]+$/.test(item.word))
                    .map(item => item.word);
                ablationInput.value = [...new Set(highImpactWords)].join(', ');
            }
            setLoadingState(false);
        });

        async function runExperiment(type) {
            setLoadingState(true, `Running ${type} study...`);
            const changes = (type === 'ablation') ? ablationInput.value : counterfactualInput.value;
            
            // --- ðŸ”´ CHANGED LINE ---
            const response = await fetch('/run_experiment', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    type: type,
                    original_prompt: appState.original_prompt,
                    original_output: appState.original_output,
                    changes: changes
                })
            });
            const data = await response.json();
            if (data.error) {
                experimentDisplay.innerHTML = `<p style="color: red;"><strong>Error:</strong> ${data.error}</p>`;
                setLoadingState(false);
                return;
            }
            // ... (rest of the function is unchanged) ...
            const originalHeatmap = buildHeatmapHTML(appState.original_analysis.heatmap_data);
            const originalReport = buildReportHTML(appState.original_analysis.connections);
            const beforeHTML = `
                <h3>Before</h3>
                <b>Prompt:</b> ${appState.original_prompt}<hr>
                <b>Heatmap:</b> ${originalHeatmap}
                <b>Significance:</b> ${originalReport}`;
            const newHeatmap = buildHeatmapHTML(data.new_analysis.heatmap_data);
            const newReport = buildReportHTML(data.new_analysis.connections);
            const afterHTML = `
                <h3>After</h3>
                <b>Prompt:</b> ${data.new_prompt}<hr>
                <b>Heatmap:</b> ${newHeatmap}
                <b>Significance:</b> ${newReport}`;
            const scoreHTML = buildScoreHTML(data.change_data);
            experimentDisplay.innerHTML = `
                <h2>${type.charAt(0).toUpperCase() + type.slice(1)} Study Results</h2>
                <div class="compare-container">
                    <div class="compare-box compare-before">${beforeHTML}</div>
                    <div class="compare-box">${afterHTML}</div>
                </div>
                <hr style='margin-top: 20px;'>
                <h3>Change Analysis</h3>
                <details style="margin-bottom: 15px; font-size: 0.9em; color: #555;">
                    <summary style="cursor: pointer; font-weight: bold;">How is this impact score computed?</summary>
                    <div style="padding: 10px; border: 1px solid #eee; border-radius: 5px; margin-top: 5px; background-color: #fafafa;">
                        <p style="margin-top: 0;">An AI model (using the <code>quantify_change</code> function) compares the <b>"Original Output"</b> with the <b>"New Output"</b>.</p>
                        <p>It assigns a <strong>"semantic change score" (1-10)</strong> based on how much the core meaning, tone, or content was altered by your experiment.</p>
                        <ul style="margin: 5px 0 0 20px; padding: 0;">
                            <li><b>Score 1:</b> No real change.</li>
                            <li><b>Score 5:</b> Moderate change (e.g., tone is different but facts are the same).</li>
                            <li><b>Score 10:</b> Complete change in meaning.</li>
                        </ul>
                    </div>
                </details>
                ${scoreHTML}
                <hr style='margin-top: 20px;'>
                <h3>Original Output</h3>
                <pre>${appState.original_output}</pre>
                <h3>New Output</h3>
                <pre>${data.new_output}</pre>
            `;
            setLoadingState(false);
        }
        bAblate.addEventListener('click', () => runExperiment('ablation'));
        bCounterfactual.addEventListener('click', ()D => runExperiment('counterfactual'));
        
        function setLoadingState(isLoading, message = '') {
            status.textContent = message;
            [bGenerate, bAnalyze, bAblate, bCounterfactual].forEach(btn => {
                btn.disabled = isLoading;
            });
            if (!isLoading) {
                bAnalyze.disabled = !outputDisplay.value;
            }
        }
    </script>
</body>
</html>